<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç”¨æˆ·æ—¥å¿—ç®¡ç†</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        background-color: #f2f2f2;
        color: #333;
        line-height: 1.6;
      }

      .container {
        padding: 20px;
        min-height: 100vh;
      }

      .page-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #ddd;
      }

      .page-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }

      .card {
        background: #fff;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow: hidden;
      }

      .card-header {
        padding: 15px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-title {
        font-size: 16px;
        font-weight: bold;
        color: #333;
      }

      .card-body {
        padding: 20px;
      }

      .search-form {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-label {
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }

      .form-control {
        padding: 8px 12px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-control:focus {
        outline: none;
        border-color: #409eff;
        box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.1);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        font-size: 14px;
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        gap: 5px;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
      }

      .btn-primary {
        background-color: #409eff;
        color: white;
        border-color: #409eff;
      }

      .btn-primary:hover {
        background-color: #66b1ff;
        border-color: #66b1ff;
      }

      .btn-danger {
        background-color: #f56c6c;
        color: white;
        border-color: #f56c6c;
      }

      .btn-danger:hover {
        background-color: #f78989;
        border-color: #f78989;
      }

      .btn-success {
        background-color: #67c23a;
        color: white;
        border-color: #67c23a;
      }

      .btn-success:hover {
        background-color: #85ce61;
        border-color: #85ce61;
      }

      .btn-default {
        background-color: #fff;
        color: #606266;
        border-color: #dcdfe6;
      }

      .btn-default:hover {
        color: #409eff;
        border-color: #c6e2ff;
        background-color: #ecf5ff;
      }

      .table-container {
        overflow-x: auto;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        font-size: 14px;
      }

      .data-table th {
        background-color: #f8f9fa;
        padding: 12px 15px;
        text-align: left;
        font-weight: bold;
        color: #333;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
      }

      .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
      }

      .data-table tbody tr:hover {
        background-color: #f8f9fa;
      }

      .data-table tbody tr.selected {
        background-color: #ecf5ff;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
      }

      .page-btn {
        padding: 6px 12px;
        margin: 0 2px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .page-btn:hover {
        background-color: #f5f5f5;
      }

      .page-btn.active {
        background-color: #409eff;
        color: white;
        border-color: #409eff;
      }

      .page-info {
        margin: 0 15px;
        color: #666;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalSlide 0.3s ease;
      }

      @keyframes modalSlide {
        from {
          opacity: 0;
          transform: translateY(-50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-title {
        font-size: 18px;
        font-weight: bold;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #999;
        padding: 5px;
      }

      .modal-close:hover {
        color: #333;
      }

      .modal-body {
        padding: 20px;
      }

      .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        text-align: right;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        color: #999;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
      }

      .checkbox-cell {
        text-align: center;
        width: 50px;
      }

      .action-cell {
        width: 150px;
      }

      @media (max-width: 768px) {
        .search-form {
          grid-template-columns: 1fr;
        }

        .card-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .data-table {
          font-size: 13px;
        }

        .data-table th,
        .data-table td {
          padding: 8px 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="page-header">
        <h1 class="page-title">ç”¨æˆ·æ—¥å¿—ç®¡ç†</h1>
      </div>

      <!-- æœç´¢å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">æœç´¢æ¡ä»¶</h2>
        </div>
        <div class="card-body">
          <form id="searchForm" class="search-form">
            <div class="form-group">
              <label class="form-label">å§“å</label>
              <input
                type="text"
                name="name"
                class="form-control"
                placeholder="è¯·è¾“å…¥å§“å"
              />
            </div>
            <div class="form-group">
              <label class="form-label">é‚®ç®±</label>
              <input
                type="text"
                name="email"
                class="form-control"
                placeholder="è¯·è¾“å…¥é‚®ç®±"
              />
            </div>
            <div class="form-group">
              <label class="form-label">æ‰‹æœºå·</label>
              <input
                type="text"
                name="phone"
                class="form-control"
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
              />
            </div>
            <div class="form-group">
              <label class="form-label">æ¥æº</label>
              <input
                type="text"
                name="orign"
                class="form-control"
                placeholder="è¯·è¾“å…¥æ¥æº"
              />
            </div>
            <div class="form-group">
              <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
              <input type="date" name="start_date" class="form-control" />
            </div>
            <div class="form-group">
              <label class="form-label">ç»“æŸæ—¥æœŸ</label>
              <input type="date" name="end_date" class="form-control" />
            </div>
          </form>
          <div style="text-align: center; margin-top: 20px">
            <button type="button" id="searchBtn" class="btn btn-primary">
              æœç´¢
            </button>
            <button type="reset" id="resetBtn" class="btn btn-default">
              é‡ç½®
            </button>
          </div>
        </div>
      </div>

      <!-- æ•°æ®è¡¨æ ¼å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ç”¨æˆ·æ—¥å¿—åˆ—è¡¨</h2>
          <div>
            <button
              style="display: none"
              id="addBtn"
              class="btn btn-success btn-sm"
            >
              â• æ·»åŠ 
            </button>
            <button
              style="display: none"
              id="batchDeleteBtn"
              class="btn btn-danger btn-sm"
            >
              ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table class="data-table" id="dataTable">
              <thead>
                <tr>
                  <th class="checkbox-cell">
                    <input type="checkbox" id="selectAll" />
                  </th>
                  <th>ID</th>
                  <th>å§“å</th>
                  <th>é‚®ç®±</th>
                  <th>æ‰‹æœºå·</th>
                  <th>æ¥æº</th>
                  <th>åˆ›å»ºæ—¶é—´</th>
                  <th class="action-cell">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <!-- æ•°æ®å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
              </tbody>
            </table>
          </div>
          <div id="loading" class="loading">åŠ è½½ä¸­...</div>
          <div id="noData" class="no-data" style="display: none">æš‚æ— æ•°æ®</div>
          <div class="pagination" id="pagination">
            <!-- åˆ†é¡µå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
          </div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal" id="editModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="modalTitle">æ·»åŠ ç”¨æˆ·æ—¥å¿—</h3>
          <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" name="id" />
            <div class="form-group" style="margin-bottom: 15px">
              <label class="form-label">å§“å</label>
              <input
                type="text"
                name="name"
                class="form-control"
                required
                placeholder="è¯·è¾“å…¥å§“å"
              />
            </div>
            <div class="form-group" style="margin-bottom: 15px">
              <label class="form-label">é‚®ç®±</label>
              <input
                type="email"
                name="email"
                class="form-control"
                required
                placeholder="è¯·è¾“å…¥é‚®ç®±"
              />
            </div>
            <div class="form-group" style="margin-bottom: 15px">
              <label class="form-label">æ‰‹æœºå·</label>
              <input
                type="tel"
                name="phone"
                class="form-control"
                required
                placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
              />
            </div>
            <div class="form-group" style="margin-bottom: 15px">
              <label class="form-label">æ¥æº</label>
              <input
                type="text"
                name="orign"
                class="form-control"
                placeholder="è¯·è¾“å…¥æ¥æº"
              />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" onclick="closeModal()">
            å–æ¶ˆ
          </button>
          <button type="button" class="btn btn-primary" onclick="submitForm()">
            æäº¤
          </button>
        </div>
      </div>
    </div>

    <script>
      // å…¨å±€å˜é‡
      let currentPage = 1;
      const pageSize = 10;
      let totalCount = 0;
      let selectedIds = new Set();
      let isLoading = false;

      // APIåŸºç¡€è·¯å¾„
      const API_BASE = {
        list: "/admin/list",
        add: "/admin/add",
        edit: "/admin/edit",
        delete: "/admin/delete",
        detail: "/admin/detail",
      };

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // ç»‘å®šäº‹ä»¶
        document
          .getElementById("searchBtn")
          .addEventListener("click", searchData);
        document
          .getElementById("resetBtn")
          .addEventListener("click", resetSearch);
        document
          .getElementById("addBtn")
          .addEventListener("click", showAddModal);
        document
          .getElementById("batchDeleteBtn")
          .addEventListener("click", batchDelete);
        document
          .getElementById("selectAll")
          .addEventListener("change", toggleSelectAll);

        // åŠ è½½åˆå§‹æ•°æ®
        loadData();
      });

      // åŠ è½½æ•°æ®
      async function loadData() {
        if (isLoading) return;

        isLoading = true;
        showLoading();

        try {
          const formData = new FormData(document.getElementById("searchForm"));
          const params = new URLSearchParams();

          // æ·»åŠ æœç´¢å‚æ•°
          for (let [key, value] of formData.entries()) {
            if (value) params.append(key, value);
          }

          // æ·»åŠ åˆ†é¡µå‚æ•°
          params.append("page", currentPage);
          params.append("limit", pageSize);

          const response = await fetch(API_BASE.list, {
            method: "POST",
            body: params,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          });

          const data = await response.json();

          if (data.code === 0) {
            renderTable(data.data);
            renderPagination(data.count);
            totalCount = data.count;
          } else {
            showError("åŠ è½½å¤±è´¥ï¼š" + data.msg);
          }
        } catch (error) {
          console.error("åŠ è½½æ•°æ®é”™è¯¯:", error);
          showError("ç½‘ç»œè¯·æ±‚å¤±è´¥");
        } finally {
          isLoading = false;
          hideLoading();
        }
      }

      // æœç´¢æ•°æ®
      function searchData() {
        currentPage = 1;
        selectedIds.clear();
        document.getElementById("selectAll").checked = false;
        loadData();
      }

      // é‡ç½®æœç´¢
      function resetSearch() {
        document.getElementById("searchForm").reset();
        searchData();
      }

      // æ¸²æŸ“è¡¨æ ¼
      function renderTable(data) {
        const tbody = document.getElementById("tableBody");

        if (!data || data.length === 0) {
          tbody.innerHTML = "";
          document.getElementById("noData").style.display = "block";
          return;
        }

        document.getElementById("noData").style.display = "none";

        let html = "";
        data.forEach((item) => {
          const isSelected = selectedIds.has(item.id);
          html += `
                    <tr class="${isSelected ? "selected" : ""}">
                        <td class="checkbox-cell">
                            <input type="checkbox" 
                                   class="row-checkbox" 
                                   data-id="${item.id}"
                                   ${isSelected ? "checked" : ""}
                                   onchange="toggleRowSelection(${item.id}, this.checked)">
                        </td>
                        <td>${item.id}</td>
                        <td>${escapeHtml(item.name || "")}</td>
                        <td>${escapeHtml(item.email || "")}</td>
                        <td>${escapeHtml(item.phone || "")}</td>
                        <td>${escapeHtml(item.orign || "")}</td>
                        <td>${item.create_time || ""}</td>
                        <td class="action-cell">
                            <div class="action-buttons">
                                <button class="btn btn-danger btn-sm" onclick="deleteRecord(${item.id})">
                                    åˆ é™¤
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
        });

        tbody.innerHTML = html;
      }

      // æ¸²æŸ“åˆ†é¡µ
      function renderPagination(total) {
        const pagination = document.getElementById("pagination");
        const totalPages = Math.ceil(total / pageSize);

        if (totalPages <= 1) {
          pagination.innerHTML = "";
          return;
        }

        let html = "";

        // ä¸Šä¸€é¡µ
        if (currentPage > 1) {
          html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
        }

        // é¡µç 
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, startPage + 4);

        for (let i = startPage; i <= endPage; i++) {
          html += `<button class="page-btn ${i === currentPage ? "active" : ""}" 
                               onclick="goToPage(${i})">${i}</button>`;
        }

        // ä¸‹ä¸€é¡µ
        if (currentPage < totalPages) {
          html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
        }

        // é¡µé¢ä¿¡æ¯
        html += `<div class="page-info">å…± ${total} æ¡ï¼Œç¬¬ ${currentPage}/${totalPages} é¡µ</div>`;

        pagination.innerHTML = html;
      }

      // è·³è½¬åˆ°æŒ‡å®šé¡µ
      function goToPage(page) {
        if (page === currentPage) return;
        currentPage = page;
        loadData();
      }

      // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
      function showAddModal() {
        document.getElementById("modalTitle").textContent = "æ·»åŠ ç”¨æˆ·æ—¥å¿—";
        document.getElementById("editForm").reset();
        document.getElementById("editModal").classList.add("active");
      }

      // ç¼–è¾‘è®°å½•
      async function editRecord(id) {
        try {
          const response = await fetch(API_BASE.detail + "?id=" + id);
          const data = await response.json();

          if (data.code === 0) {
            document.getElementById("modalTitle").textContent = "ç¼–è¾‘ç”¨æˆ·æ—¥å¿—";
            const form = document.getElementById("editForm");
            form.querySelector('[name="id"]').value = data.data.id;
            form.querySelector('[name="name"]').value = data.data.name || "";
            form.querySelector('[name="email"]').value = data.data.email || "";
            form.querySelector('[name="phone"]').value = data.data.phone || "";
            form.querySelector('[name="orign"]').value = data.data.orign || "";
            document.getElementById("editModal").classList.add("active");
          } else {
            alert("è·å–æ•°æ®å¤±è´¥ï¼š" + data.msg);
          }
        } catch (error) {
          console.error("ç¼–è¾‘é”™è¯¯:", error);
          alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
        }
      }

      // å…³é—­æ¨¡æ€æ¡†
      function closeModal() {
        document.getElementById("editModal").classList.remove("active");
      }

      // æäº¤è¡¨å•
      async function submitForm() {
        const form = document.getElementById("editForm");
        const formData = new FormData(form);
        const params = new URLSearchParams();

        for (let [key, value] of formData.entries()) {
          if (value) params.append(key, value);
        }

        // è¡¨å•éªŒè¯
        if (!form.querySelector('[name="name"]').value.trim()) {
          alert("è¯·è¾“å…¥å§“å");
          return;
        }

        if (!form.querySelector('[name="email"]').value.trim()) {
          alert("è¯·è¾“å…¥é‚®ç®±");
          return;
        }

        if (!form.querySelector('[name="phone"]').value.trim()) {
          alert("è¯·è¾“å…¥æ‰‹æœºå·");
          return;
        }

        const url = form.querySelector('[name="id"]').value
          ? API_BASE.edit
          : API_BASE.add;

        // å¦‚æœæ˜¯æ–°å¢ï¼Œæ·»åŠ åˆ›å»ºæ—¶é—´
        if (!form.querySelector('[name="id"]').value) {
          params.append(
            "create_time",
            new Date().toISOString().slice(0, 19).replace("T", " "),
          );
        }

        try {
          const response = await fetch(url, {
            method: "POST",
            body: params,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          });

          const data = await response.json();

          if (data.code === 0) {
            alert(data.msg);
            closeModal();
            loadData();
          } else {
            alert("æ“ä½œå¤±è´¥ï¼š" + data.msg);
          }
        } catch (error) {
          console.error("æäº¤é”™è¯¯:", error);
          alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
        }
      }

      // åˆ é™¤è®°å½•
      function deleteRecord(id) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) return;

        const params = new URLSearchParams();
        params.append("id", id);

        fetch(API_BASE.delete, {
          method: "POST",
          body: params,
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.code === 0) {
              alert(data.msg);
              loadData();
            } else {
              alert("åˆ é™¤å¤±è´¥ï¼š" + data.msg);
            }
          })
          .catch((error) => {
            console.error("åˆ é™¤é”™è¯¯:", error);
            alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
          });
      }

      // å…¨é€‰/å…¨ä¸é€‰
      function toggleSelectAll() {
        const isChecked = document.getElementById("selectAll").checked;
        const checkboxes = document.querySelectorAll(".row-checkbox");

        checkboxes.forEach((checkbox) => {
          checkbox.checked = isChecked;
          const id = parseInt(checkbox.dataset.id);
          if (isChecked) {
            selectedIds.add(id);
          } else {
            selectedIds.delete(id);
          }
        });

        // æ›´æ–°è¡Œæ ·å¼
        const rows = document.querySelectorAll("#tableBody tr");
        rows.forEach((row) => {
          if (isChecked) {
            row.classList.add("selected");
          } else {
            row.classList.remove("selected");
          }
        });
      }

      // åˆ‡æ¢è¡Œé€‰æ‹©
      function toggleRowSelection(id, checked) {
        if (checked) {
          selectedIds.add(id);
        } else {
          selectedIds.delete(id);
          document.getElementById("selectAll").checked = false;
        }

        // æ›´æ–°è¡Œæ ·å¼
        const row = document
          .querySelector(`.row-checkbox[data-id="${id}"]`)
          .closest("tr");
        if (checked) {
          row.classList.add("selected");
        } else {
          row.classList.remove("selected");
        }
      }

      // æ‰¹é‡åˆ é™¤
      function batchDelete() {
        if (selectedIds.size === 0) {
          alert("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•");
          return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedIds.size} æ¡è®°å½•å—ï¼Ÿ`)) return;

        const params = new URLSearchParams();
        params.append("id", Array.from(selectedIds));

        fetch(API_BASE.delete, {
          method: "POST",
          body: params,
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.code === 0) {
              alert(data.msg);
              selectedIds.clear();
              document.getElementById("selectAll").checked = false;
              loadData();
            } else {
              alert("åˆ é™¤å¤±è´¥ï¼š" + data.msg);
            }
          })
          .catch((error) => {
            console.error("æ‰¹é‡åˆ é™¤é”™è¯¯:", error);
            alert("ç½‘ç»œè¯·æ±‚å¤±è´¥");
          });
      }

      // æ˜¾ç¤ºåŠ è½½ä¸­
      function showLoading() {
        document.getElementById("loading").style.display = "flex";
      }

      // éšè—åŠ è½½ä¸­
      function hideLoading() {
        document.getElementById("loading").style.display = "none";
      }

      // æ˜¾ç¤ºé”™è¯¯
      function showError(message) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; color: #f56c6c; padding: 40px;">
                        ${escapeHtml(message)}
                    </td>
                </tr>
            `;
        document.getElementById("pagination").innerHTML = "";
      }

      // HTMLè½¬ä¹‰
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>
